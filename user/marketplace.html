{% extends "base.html" %}

{% block title %}Marketplace - Apartment Hub{% endblock %}

{% block content %}
<div class="card">
    <h2 style="color: var(--primary); margin-bottom: 2rem;">
        <i class="fas fa-shopping-bag"></i> Community Marketplace
    </h2>

    <!-- Search and Filter -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 2rem;">
        <form method="GET" action="{{ url_for('marketplace') }}" class="search-container">
            <input type="text" name="search" class="search-input" placeholder="Search products..." value="{{ search }}">
            <button type="submit" class="search-btn">
                <i class="fas fa-search"></i>
            </button>
        </form>

        <select class="form-control" onchange="window.location.href='{{ url_for('marketplace') }}?category='+this.value" style="margin-bottom: 0;">
            <option value="">All Categories</option>
            {% for cat in categories %}
                <option value="{{ cat.category }}" {% if category == cat.category %}selected{% endif %}>
                    {{ cat.category }}
                </option>
            {% endfor %}
        </select>
    </div>

    {% if search or category %}
    <div style="background: #e7f3ff; padding: 1rem; border-radius: var(--radius); margin-bottom: 2rem;">
        <p style="margin-bottom: 0;">
            <i class="fas fa-filter"></i> 
            Showing results {% if search %}for "{{ search }}"{% endif %}{% if search and category %} and {% endif %}{% if category %}in {{ category }}{% endif %}
            <a href="{{ url_for('marketplace') }}" style="margin-left: 1rem; color: var(--primary);">Clear filters</a>
        </p>
    </div>
    {% endif %}

    <!-- Products Grid -->
    <div class="grid grid-3">
        {% for product in products %}
        <div class="card" style="padding: 1.5rem; position: relative;">
            {% if product.image %}
            <img src="{{ url_for('static', filename='uploads/' + product.image) }}" 
                 class="product-img" alt="{{ product.name }}">
            {% else %}
            <div style="width: 100%; height: 200px; background: #f8f9fa; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--gray);">
                <i class="fas fa-image" style="font-size: 3rem;"></i>
            </div>
            {% endif %}
            
            <h3 style="margin: 1rem 0 0.5rem; color: var(--primary);">{{ product.name }}</h3>
            <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0.5rem;">{{ product.category }}</p>
            
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem; font-weight: 600; color: var(--success);">â‚¹{{ product.price }}</span>
                <span style="background: {% if product.quantity > 5 %}#10b981{% elif product.quantity > 0 %}#f59e0b{% else %}#ef4444{% endif %}; 
                      color: white; padding: 0.25rem 0.5rem; border-radius: 20px; font-size: 0.8rem;">
                    {{ product.quantity }} in stock
                </span>
            </div>
            
            {% if product.description %}
            <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 1rem;">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</p>
            {% endif %}
            
            <div style="background: #f8f9fa; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
                <div style="display: flex; justify-content: between; margin-bottom: 0.5rem;">
                    <span>Seller:</span>
                    <strong>{{ product.username }}</strong>
                </div>
                <div style="display: flex; justify-content: between; margin-bottom: 0.5rem;">
                    <span>Contact:</span>
                    <strong>{{ product.contact_number }}</strong>
                </div>
                <div style="display: flex; justify-content: between;">
                    <span>House No:</span>
                    <strong>{{ product.house_no }}</strong>
                </div>
            </div>
            
            {% if product.quantity > 0 %}
            <form method="POST" action="{{ url_for('buy_product', product_id=product.id) }}" 
                  style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" name="quantity" min="1" max="{{ product.quantity }}" 
                       value="1" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: var(--radius);">
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="fas fa-shopping-cart"></i> Buy
                </button>
            </form>
            {% else %}
            <button class="btn btn-secondary btn-sm" disabled style="width: 100%;">
                <i class="fas fa-times"></i> Out of Stock
            </button>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    {% if not products %}
    <div style="text-align: center; padding: 3rem; color: var(--gray);">
        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem;"></i>
        <h3>No products found</h3>
        <p>{% if search or category %}Try different search terms or categories{% else %}No products available in the marketplace yet{% endif %}</p>
        {% if not search and not category %}
        <a href="{{ url_for('add_product') }}" class="btn btn-primary mt-2">
            <i class="fas fa-plus"></i> Be the first to add a product
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}